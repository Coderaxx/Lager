<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagerføringssystem</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <section class="section">
        <div class="container">
            <nav class="level">
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Hyller</p>
                        <p class="title" id="shelfCount">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Seksjoner</p>
                        <p class="title" id="sectionCount">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Etasjer</p>
                        <p class="title" id="levelCount">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Lagerbeholdning</p>
                        <p class="title" id="itemCount">-</p>
                    </div>
                </div>
            </nav>
            <hr>
            <h1 class="title">Lagerføringssystem "Sønnico"-lager</h1>
            <form id="barcodeForm" class="box">
                <div class="field">
                    <label class="label">Strekkode eller tekst</label>
                    <div class="control">
                        <input class="input" type="text" name="barcode" placeholder="Skriv inn strekkode eller tekst"
                            required autofocus />
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <button class="button is-primary">Søk</button>
                    </div>
                </div>
            </form>
            <br>
            <div id="result" class="notification is-hidden"></div>
        </div>
    </section>
    <footer class="footer">
        <div class="content has-text-centered">
            <strong>Lagerføringssystem</strong> av <a href="https://github.com/Coderaxx/">Jesper Grimstad</a>.
        </div>
    </footer>
    <script>
        async function countInventory() {
            const count = {
                itemCount: 0,
                shelfCount: 0,
                sectionCount: 0,
                levelCount: 0,
            };

            try {
                const response = await fetch("/inventory");
                const data = await response.json();

                if (response.ok) {
                    for (const category of data.categories) {
                        for (const shelf of category.shelves) {
                            count.shelfCount += 1;

                            for (const section of shelf.sections) {
                                count.sectionCount += 1;

                                for (const level of section.levels) {
                                    count.levelCount += 1;
                                    count.itemCount += level.items.length;
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(error);
            }

            return count;
        }

        $(document).ready(async () => {
            const itemCount = document.getElementById("itemCount");
            const shelfCount = document.getElementById("shelfCount");
            const sectionCount = document.getElementById("sectionCount");
            const levelCount = document.getElementById("levelCount");

            try {
                const count = await countInventory();
                itemCount.textContent = count.itemCount;
                shelfCount.textContent = count.shelfCount;
                sectionCount.textContent = count.sectionCount;
                levelCount.textContent = count.levelCount;
            } catch (error) {
                console.error(error);
            }
        });

        const barcodeForm = document.getElementById("barcodeForm");
        const resultElement = document.getElementById("result");

        barcodeForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const barcode = e.target.elements.barcode.value;

            try {
                const response = await fetch(`/inventory/search/${barcode}`);
                const data = await response.json();

                if (response.ok) {
                    resultElement.innerHTML = "";

                    for (const category in data) {
                        const categorySection = document.createElement("section");
                        categorySection.className = "section";

                        const categoryTitle = document.createElement("h2");
                        categoryTitle.className = "title";
                        categoryTitle.textContent = `${category}`;
                        categorySection.appendChild(categoryTitle);

                        const columns = document.createElement("div");
                        columns.className = "columns is-multiline";

                        const categoryItems = Array.isArray(data[category]) ? data[category] : [data[category]];

                        for (const item of categoryItems) {
                            const column = document.createElement("div");
                            column.className = "column is-one-third";

                            const card = document.createElement("div");
                            card.className = "card";

                            const cardContent = document.createElement("div");
                            cardContent.className = "card-content";

                            const media = document.createElement("div");
                            media.className = "media";

                            const mediaContent = document.createElement("div");
                            mediaContent.className = "media-content";

                            const title = document.createElement("p");
                            title.className = "title is-4";
                            title.textContent = `${item.brand} ${item.model}`;

                            const location = document.createElement("div");
                            location.className = "content";
                            location.innerHTML = `
                                <p>Hylle: ${item.location.split(".")[1]}</p>
                                <p>Seksjon: ${item.location.split(".")[2]}</p>
                                <p>Etasje: ${item.location.split(".")[3]}</p>
                                <p>Full plassering: ${item.location}</p>
                            `;

                            categoryTitle.textContent = `${item.location}`;

                            mediaContent.appendChild(title);
                            mediaContent.appendChild(location);
                            media.appendChild(mediaContent);
                            cardContent.appendChild(media);
                            card.appendChild(cardContent);
                            column.appendChild(card);
                            columns.appendChild(column);
                        }

                        categorySection.appendChild(columns);
                        resultElement.appendChild(categorySection);
                    }

                    resultElement.classList.remove("is-hidden", "is-danger");
                    resultElement.classList.add("is-success");
                } else {
                    resultElement.classList.remove("is-hidden", "is-success");
                    resultElement.classList.add("is-danger");
                    resultElement.textContent = data.message;
                }
            } catch (error) {
                console.error(error);
            }
        });
    </script>

</body>

</html>