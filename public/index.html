<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagerføringssystem</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://js.sentry-cdn.com/3c602fc817b942cbaf82608c5d9450fe.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0/umd/zxing-browser.min.js"></script>

    <link rel="icon" type="image/svg+xml" href="assets/img/favicon.svg">
    <link rel="icon" type="image/png" href="assets/img/favicon.png">
    <style type="text/css">
        .image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 150px;
            border: 1px solid #000;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>

<body>
    <section class="section">
        <div class="container">
            <nav class="level is-mobile">
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Hyller</p>
                        <p class="title" id="shelfCount">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Hyllenivå</p>
                        <p class="title" id="levelCount">-</p>
                    </div>
                </div>
                <div class="level-item has-text-centered">
                    <div>
                        <p class="heading">Lagerbeholdning</p>
                        <p class="title" id="itemCount">-</p>
                    </div>
                </div>
            </nav>
            <hr>
            <h1 class="title">Lagerføringssystem OneCo-lager</h1>
            <form id="barcodeForm" class="box">
                <div class="field">
                    <label class="label">Strekkode eller tekst</label>
                    <div class="control">
                        <input class="input" type="text" name="barcode" id="barcode"
                            placeholder="Skriv inn strekkode eller tekst" required autofocus autocomplete="off"
                            onblur="this.focus()" />
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <button class="button is-primary">Søk</button>
                        <button id="scanButton" class="button is-info">Skann</button>
                    </div>
                    <div id="barcodeScanner"></div>
                </div>
            </form>
            <br>
            <div id="result" class="notification is-hidden"></div>
        </div>
    </section>
    <!--<footer class="footer">
        <div class="content has-text-centered">
            <strong>Lagerføringssystem</strong> av <a href="https://github.com/Coderaxx/">Jesper Grimstad</a>.
        </div>
    </footer>-->
    <script>
        function openBarcodeScanner() {
            const codeReader = new ZXing.BrowserBarcodeReader();

            // Åpne mobilkameraet og start strekkodeskanning
            codeReader
                .decodeOnceFromVideoDevice(undefined, 'barcodeScanner')
                .then((result) => {
                    const barcode = result.text;
                    // Utfør handling med den skannede strekkoden, for eksempel søk
                    searchInventoryByBarcode(barcode)
                        .then(({ brand, model, image }) => {
                            brandInput.value = brand;
                            modelInput.value = model;
                            imageInput.value = image;
                            modelInput.focus();
                        })
                        .catch((error) => {
                            Sentry.captureException(error);
                            console.error("Feil ved søk etter strekkode:", error);
                            brandInput.value = "";
                            modelInput.value = "";
                            brandInput.focus();
                        });
                })
                .catch((error) => {
                    console.error("Feil ved skanning av strekkode:", error);
                });
        }

        // Lytt etter klikk på "Skann" -knappen
        const scanButton = document.getElementById("scanButton");
        scanButton.addEventListener("click", openBarcodeScanner);

        async function countInventory() {
            const count = {
                itemCount: 0,
                shelfCount: 0,
                levelCount: 0,
            };

            try {
                const response = await fetch("/inventory");
                const data = await response.json();

                if (response.ok) {
                    for (const category of data.categories) {
                        for (const shelf of category.shelves) {
                            count.shelfCount += 1;

                            for (const level of shelf.levels) {
                                count.levelCount += 1;
                                count.itemCount += level.items.length;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(error);
            }

            return count;
        }

        //Sett denne funksjonen til å kjøre hvert sekund.
        setInterval(async () => {
            const itemCount = document.getElementById("itemCount");
            const shelfCount = document.getElementById("shelfCount");
            const levelCount = document.getElementById("levelCount");

            try {
                const count = await countInventory();
                itemCount.textContent = count.itemCount;
                shelfCount.textContent = count.shelfCount;
                levelCount.textContent = count.levelCount;
            } catch (error) {
                console.error(error);
            }
        }, 1000);

        document.getElementById("barcode").addEventListener("input", () => {
            const input = barcode.value;
            barcode.value = input.toUpperCase();
        });

        const barcodeForm = document.getElementById("barcodeForm");
        const resultElement = document.getElementById("result");

        barcodeForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const barcode = e.target.elements.barcode.value;

            try {
                const response = await fetch(`/inventory/search/${barcode}`);
                const data = await response.json();

                if (response.ok) {
                    resultElement.innerHTML = "";

                    const columns = document.createElement("div");
                    columns.className = "columns is-multiline";

                    for (const item of data) {
                        const itemLocation = item.location;
                        const itemKey = `${item.brand}_${item.model}`;
                        const itemCount = item.quantity;

                        const column = document.createElement("div");
                        column.className = "column is-one-third"; // Bruk en fjerdedel av bredden på hver rad

                        const box = document.createElement("div");
                        box.className = "box";

                        const content = document.createElement("div");
                        content.className = "columns is-multiline";

                        const topLeft = document.createElement("div");
                        topLeft.className = "column is-half";

                        const topRight = document.createElement("div");
                        topRight.className = "column is-half";

                        const HR = document.createElement("hr");

                        const bottomLeft = document.createElement("div");
                        bottomLeft.className = "column is-half";

                        const bottomRight = document.createElement("div");
                        bottomRight.className = "column is-half";

                        if (item.image.length > 0) {
                            const imageContainer = document.createElement("div");
                            imageContainer.className = "image-container";

                            const image = document.createElement("img");
                            image.src = item.image;
                            image.alt = `Bilde av ${item.brand} ${item.model}`;
                            image.className = "product-image";

                            imageContainer.appendChild(image);
                            topLeft.appendChild(imageContainer);
                        }

                        const barcode = document.createElement("p");
                        barcode.innerHTML = `<center><strong>Strekkode</strong></center><br>`;
                        const barcodeImage = document.createElement("img");
                        barcodeImage.src = `https://barcode.tec-it.com/barcode.ashx?data=${item.barcode}&code=${item.barcode.length == 13 ? "EAN13" : "Code128"}`;
                        barcodeImage.alt = "Strekkode";
                        barcodeImage.style.display = "align-self: center; block;";
                        barcodeImage.style.margin = "auto";
                        //barcodeImage.style.marginTop = "25%";

                        topRight.appendChild(barcode);
                        topRight.appendChild(barcodeImage);

                        const brandModel = document.createElement("p");
                        brandModel.innerHTML = `<strong>Merke:</strong> ${item.brand}<br><strong>Modell:</strong> ${item.model}`;

                        bottomLeft.appendChild(brandModel);

                        const articleNumber = document.createElement("p");
                        articleNumber.innerHTML = `<strong>Art. nr.:</strong> ${item.articleNumber}`;

                        bottomLeft.appendChild(articleNumber);

                        const shelf = document.createElement("p");
                        shelf.innerHTML = `<strong>Hylle:</strong> ${itemLocation.split(".")[1]}`;

                        bottomRight.appendChild(shelf);

                        const fullLocation = document.createElement("p");
                        fullLocation.innerHTML = `<strong>Full plassering:</strong> ${itemLocation}`;

                        bottomRight.appendChild(fullLocation);

                        const count = document.createElement("p");
                        count.innerHTML = `<strong>Antall:</strong> ${itemCount}`;

                        bottomRight.appendChild(count);

                        content.appendChild(topLeft);
                        content.appendChild(topRight);
                        content.appendChild(HR);
                        content.appendChild(bottomLeft);
                        content.appendChild(bottomRight);

                        box.appendChild(content);
                        column.appendChild(box);
                        columns.appendChild(column);
                    }

                    resultElement.appendChild(columns);

                    resultElement.classList.remove("is-hidden", "is-danger");
                    resultElement.classList.add("is-success");
                    barcodeForm.reset();
                } else {
                    resultElement.classList.remove("is-hidden", "is-success");
                    resultElement.classList.add("is-danger");
                    resultElement.textContent = data.message;
                    barcodeForm.reset();
                }
            } catch (error) {
                console.error(error);
            }
        });
    </script>
</body>

</html>